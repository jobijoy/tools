<UserControl x:Class="IdolClick.UI.Controls.AgentChatControl"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml">
    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="*" MinWidth="300"/>
            <ColumnDefinition x:Name="AgentLogSplitterCol" Width="Auto"/>
            <ColumnDefinition x:Name="AgentLogPanelCol" Width="350" MinWidth="200" MaxWidth="600"/>
        </Grid.ColumnDefinitions>

        <!-- Chat area (left) -->
        <Border Grid.Column="0" Margin="8,6,4,4" 
                Background="{StaticResource SurfaceBrush}" CornerRadius="6">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                <!-- Chat Header -->
                <Border Grid.Row="0" Background="{StaticResource CardBrush}" CornerRadius="6,6,0,0" Padding="12,8">
                    <Grid>
                        <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                            <TextBlock Text="ðŸ¤–" FontSize="14" VerticalAlignment="Center" Margin="0,0,6,0"/>
                            <TextBlock Text="Agent" FontSize="{StaticResource FontSizeBodySm}" FontWeight="SemiBold" 
                                       Foreground="{StaticResource TextBrush}" VerticalAlignment="Center"/>
                            <TextBlock x:Name="AgentStatusText" Text="  â€¢  Not connected" FontSize="{StaticResource FontSizeSmall}" 
                                       Foreground="{StaticResource TextSecondaryBrush}" VerticalAlignment="Center"/>
                        </StackPanel>
                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" VerticalAlignment="Center">
                            <Button Content="ðŸ“‚" Style="{StaticResource SmallIconButton}" 
                                    Click="LoadFlow_Click" 
                                    ToolTip="Load flow from JSON file" Width="24" Height="22" Margin="0,0,2,0"/>
                            <Button Content="ðŸ“‹" Style="{StaticResource SmallIconButton}" 
                                    Click="PasteFlow_Click" 
                                    ToolTip="Paste flow from clipboard" Width="24" Height="22" Margin="0,0,2,0"/>
                            <Button x:Name="ToggleAgentLogBtn" Content="ðŸ“Š" Style="{StaticResource SmallIconButton}" 
                                    Click="ToggleAgentLog_Click" 
                                    ToolTip="Toggle log panel" Width="24" Height="22" Margin="0,0,2,0"/>
                            <Button Content="ðŸ§ª" Style="{StaticResource SmallIconButton}" 
                                    Click="SmokeTest_Click" 
                                    ToolTip="Run smoke tests" Width="24" Height="22" Margin="0,0,2,0"/>
                            <Button Content="&#x1F3AC;" Style="{StaticResource SmallIconButton}" 
                                    Click="Demo_Click" 
                                    ToolTip="Run live demo" Width="24" Height="22" Margin="0,0,2,0"/>
                            <Button Content="&#x1F5D1;" Style="{StaticResource SmallIconButton}" 
                                    HorizontalAlignment="Right" Click="ClearChat_Click" 
                                    ToolTip="Clear conversation" Width="24" Height="22"/>
                        </StackPanel>
                    </Grid>
                </Border>

                <!-- Chat Messages -->
                <ScrollViewer x:Name="ChatScrollViewer" Grid.Row="1" 
                              VerticalScrollBarVisibility="Auto" 
                              HorizontalScrollBarVisibility="Disabled"
                              Background="{StaticResource SurfaceBrush}">
                    <StackPanel x:Name="ChatMessagesPanel" Margin="0,4,0,4"/>
                </ScrollViewer>

                <!-- Welcome Message -->
                <StackPanel x:Name="AgentWelcomePanel" Grid.Row="1" 
                            VerticalAlignment="Center" HorizontalAlignment="Center" Margin="30">
                    <TextBlock Text="ðŸ¤–" FontSize="36" HorizontalAlignment="Center" Margin="0,0,0,12"/>
                    <TextBlock Text="IdolClick Agent" FontSize="16" FontWeight="SemiBold" 
                               Foreground="{StaticResource TextBrush}" HorizontalAlignment="Center" Margin="0,0,0,6"/>
                    <TextBlock Text="Describe what you want to automate in plain English." 
                               FontSize="12" Foreground="{StaticResource TextSecondaryBrush}" 
                               HorizontalAlignment="Center" TextWrapping="Wrap" TextAlignment="Center" Margin="0,0,0,16"/>
                    <TextBlock FontSize="11" Foreground="{StaticResource TextSecondaryBrush}" 
                               HorizontalAlignment="Center" TextWrapping="Wrap" TextAlignment="Center"
                               LineHeight="20">
                        <Run Text="Try:"/><LineBreak/>
                        <Run Text="â€¢ &#x22;Click the Allow button in VS Code every 5 seconds&#x22;" Foreground="{StaticResource AccentBrush}"/><LineBreak/>
                        <Run Text="â€¢ &#x22;List all my current rules&#x22;" Foreground="{StaticResource AccentBrush}"/><LineBreak/>
                        <Run Text="â€¢ &#x22;What windows are open right now?&#x22;" Foreground="{StaticResource AccentBrush}"/>
                    </TextBlock>
                    <Border Margin="0,20,0,0" Padding="8,6" Background="{StaticResource CardBrush}" CornerRadius="4">
                        <TextBlock FontSize="10" Foreground="{StaticResource WarningBrush}" 
                                   HorizontalAlignment="Center" TextWrapping="Wrap" TextAlignment="Center">
                            <Run Text="âš™ Configure your LLM endpoint in Settings to get started."/>
                        </TextBlock>
                    </Border>
                </StackPanel>

                <!-- Chat Input -->
                <Border Grid.Row="2" Background="{StaticResource CardBrush}" Padding="8" CornerRadius="0,0,6,6">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        <TextBox x:Name="ChatInputBox" Grid.Column="0" 
                                 FontSize="12" Padding="10,8" 
                                 AcceptsReturn="True"
                                 TextWrapping="Wrap"
                                 VerticalScrollBarVisibility="Auto"
                                 MinHeight="34" MaxHeight="120"
                                 KeyDown="ChatInput_KeyDown"
                                 TextChanged="ChatInput_TextChanged"
                                 VerticalAlignment="Stretch">
                            <TextBox.Style>
                                <Style TargetType="TextBox" BasedOn="{StaticResource {x:Type TextBox}}">
                                    <Setter Property="Tag" Value="Ask the agent anything... (Shift+Enter for new line)"/>
                                </Style>
                            </TextBox.Style>
                        </TextBox>
                        <Button x:Name="MicButton" Grid.Column="1" Content="ðŸŽ¤" 
                                Style="{StaticResource MicButton}" 
                                Click="MicButton_Click" 
                                Width="36" Height="34" FontSize="14" Margin="4,0,0,0"
                                ToolTip="Voice input â€” click to start recording"
                                VerticalAlignment="Bottom"
                                Visibility="Collapsed"/>
                        <Button x:Name="ChatSendBtn" Grid.Column="2" Content="âž¤" 
                                Style="{StaticResource SmallPrimaryButton}" 
                                Click="ChatSend_Click" 
                                Width="36" Height="34" FontSize="14" Margin="4,0,0,0"
                                ToolTip="Send message (Enter)"
                                VerticalAlignment="Bottom"
                                IsEnabled="False"/>
                    </Grid>
                </Border>
            </Grid>
        </Border>

        <!-- Vertical Splitter -->
        <GridSplitter x:Name="AgentLogSplitter" Grid.Column="1" Width="5" 
                      HorizontalAlignment="Center" VerticalAlignment="Stretch"
                      Background="{StaticResource SurfaceBrush}" Cursor="SizeWE"/>

        <!-- Right Side Panel: Log / Timeline -->
        <Border x:Name="AgentLogPanel" Grid.Column="2" Margin="4,6,8,4" 
                Background="{StaticResource SurfaceBrush}" CornerRadius="6">
<TabControl x:Name="AgentSideTabs" Background="Transparent" BorderThickness="0" FontSize="{StaticResource FontSizeSmall}">
                
                <!-- Log Tab -->
                <TabItem Header="ðŸ“‹ Log">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>

                        <Border Grid.Row="0" Background="{StaticResource CardBrush}" Padding="8,4">
                            <Grid>
                                <StackPanel Orientation="Horizontal">
                                    <ComboBox x:Name="AgentLogLevelCombo" Width="70" FontSize="{StaticResource FontSizeTiny}" SelectionChanged="AgentLogLevel_Changed">
                                        <ComboBoxItem Content="Debug"/>
                                        <ComboBoxItem Content="Info" IsSelected="True"/>
                                        <ComboBoxItem Content="Warning"/>
                                        <ComboBoxItem Content="Error"/>
                                    </ComboBox>
                                </StackPanel>
                                <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                                    <Button Content="Clear" Style="{StaticResource SmallButton}" Click="ClearAgentLog_Click" Margin="0,0,4,0"/>
                                    <Button Content="Open" Style="{StaticResource SmallButton}" Click="OpenLogFile_Click"/>
                                </StackPanel>
                            </Grid>
                        </Border>

                        <ListBox x:Name="AgentLogListBox" Grid.Row="1" BorderThickness="0" 
                                 Background="{StaticResource SurfaceBrush}" 
                                 Foreground="{StaticResource TextBrush}"
                                 FontSize="{StaticResource FontSizeTiny}"
                                 SelectionMode="Extended"
                                 ScrollViewer.HorizontalScrollBarVisibility="Auto">
                            <ListBox.ItemContainerStyle>
                                <Style TargetType="ListBoxItem">
                                    <Setter Property="FontSize" Value="{StaticResource FontSizeTiny}"/>
                                    <Setter Property="Padding" Value="3,1"/>
                                    <Setter Property="Margin" Value="0"/>
                                    <Setter Property="MinHeight" Value="0"/>
                                </Style>
                            </ListBox.ItemContainerStyle>
                            <ListBox.ContextMenu>
                                <ContextMenu>
                                    <MenuItem Header="ðŸ“‹ Copy Selected" Click="CopySelectedLog_Click" InputGestureText="Ctrl+C"/>
                                    <MenuItem Header="ðŸ“‹ Copy All" Click="CopyAllLog_Click"/>
                                    <Separator/>
                                    <MenuItem Header="Select All" Click="SelectAllLog_Click" InputGestureText="Ctrl+A"/>
                                </ContextMenu>
                            </ListBox.ContextMenu>
                        </ListBox>
                    </Grid>
                </TabItem>
                
                <!-- Timeline Tab -->
                <TabItem Header="ðŸ“Š Timeline">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>

                        <Border Grid.Row="0" Background="{StaticResource CardBrush}" Padding="8,4">
                            <Grid>
                                <ComboBox x:Name="AgentTimelineFilterCombo" Width="100" FontSize="{StaticResource FontSizeTiny}" SelectionChanged="AgentTimelineFilter_Changed">
                                    <ComboBoxItem Content="All" IsSelected="True" Tag=""/>
                                    <ComboBoxItem Content="Matches" Tag="RuleMatch"/>
                                    <ComboBoxItem Content="Actions" Tag="Action"/>
                                </ComboBox>
                                <Button Content="Clear" Style="{StaticResource SmallButton}" HorizontalAlignment="Right" Click="ClearAgentTimeline_Click"/>
                            </Grid>
                        </Border>

                        <ListView x:Name="AgentTimelineListView" Grid.Row="1" BorderThickness="0"
                                  Background="{StaticResource SurfaceBrush}" FontSize="{StaticResource FontSizeMicro}">
                            <ListView.View>
                                <GridView>
                                    <GridViewColumn Header="" Width="20">
                                        <GridViewColumn.CellTemplate>
                                            <DataTemplate>
                                                <TextBlock Text="{Binding Icon}" FontSize="{StaticResource FontSizeTiny}"/>
                                            </DataTemplate>
                                        </GridViewColumn.CellTemplate>
                                    </GridViewColumn>
                                    <GridViewColumn Header="Time" Width="50">
                                        <GridViewColumn.CellTemplate>
                                            <DataTemplate>
                                                <TextBlock Text="{Binding Timestamp, StringFormat={}{0:HH:mm:ss}}" 
                                                           Foreground="{StaticResource TextSecondaryBrush}"/>
                                            </DataTemplate>
                                        </GridViewColumn.CellTemplate>
                                    </GridViewColumn>
                                    <GridViewColumn Header="Event" Width="200" DisplayMemberBinding="{Binding Message}"/>
                                </GridView>
                            </ListView.View>
                        </ListView>
                    </Grid>
                </TabItem>
            </TabControl>
        </Border>
    </Grid>
</UserControl>
