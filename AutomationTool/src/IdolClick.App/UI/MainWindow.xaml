<Window x:Class="IdolClick.UI.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        mc:Ignorable="d"
        Title="Idol Click" 
        Height="420" Width="770"
        MinHeight="280" MinWidth="580"
        Background="{StaticResource BackgroundBrush}"
        WindowStartupLocation="CenterScreen"
        Icon="/Assets/idol-click.png"
        Closing="Window_Closing"
        SizeChanged="Window_SizeChanged"
        StateChanged="Window_StateChanged">

    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition x:Name="ProfilePaneColumn" Width="180"/>
            <ColumnDefinition Width="*"/>
        </Grid.ColumnDefinitions>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition x:Name="SplitterRow" Height="Auto"/>
            <RowDefinition x:Name="LogPanelRow" Height="0"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Profile Pane (Left) - Spans all rows -->
        <Border x:Name="ProfilePane" Grid.Column="0" Grid.RowSpan="5" 
                Background="{StaticResource CardBrush}" 
                Visibility="Visible" Width="180">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>
                
                <!-- Header -->
                <Border Grid.Row="0" Background="{StaticResource SurfaceBrush}" Padding="14,12">
                    <Grid>
                        <TextBlock Text="Profiles" FontWeight="SemiBold" FontSize="13" 
                                   Foreground="{StaticResource TextBrush}" VerticalAlignment="Center"/>
                        <Button Content="âœ•" Style="{StaticResource SmallIconButton}" 
                                HorizontalAlignment="Right" Click="HideProfilePane_Click"
                                Width="22" Height="22" FontSize="11" Padding="0"
                                ToolTip="Hide profile pane"/>
                    </Grid>
                </Border>
                
                <!-- Profile List -->
                <ListBox x:Name="ProfileListBox" Grid.Row="1" 
                         Background="Transparent" BorderThickness="0"
                         Foreground="{StaticResource TextBrush}"
                         SelectionChanged="ProfileListBox_SelectionChanged"
                         FontSize="12" Padding="8,6">
                    <ListBox.ItemContainerStyle>
                        <Style TargetType="ListBoxItem">
                            <Setter Property="Padding" Value="12,10"/>
                            <Setter Property="Margin" Value="0,2"/>
                            <Setter Property="Cursor" Value="Hand"/>
                            <Setter Property="Template">
                                <Setter.Value>
                                    <ControlTemplate TargetType="ListBoxItem">
                                        <Border x:Name="Bd" Background="{TemplateBinding Background}" 
                                                Padding="{TemplateBinding Padding}" CornerRadius="6">
                                            <ContentPresenter/>
                                        </Border>
                                        <ControlTemplate.Triggers>
                                            <Trigger Property="IsSelected" Value="True">
                                                <Setter TargetName="Bd" Property="Background" Value="{StaticResource AccentBrush}"/>
                                            </Trigger>
                                            <MultiTrigger>
                                                <MultiTrigger.Conditions>
                                                    <Condition Property="IsMouseOver" Value="True"/>
                                                    <Condition Property="IsSelected" Value="False"/>
                                                </MultiTrigger.Conditions>
                                                <Setter TargetName="Bd" Property="Background" Value="{StaticResource SurfaceBrush}"/>
                                            </MultiTrigger>
                                        </ControlTemplate.Triggers>
                                    </ControlTemplate>
                                </Setter.Value>
                            </Setter>
                        </Style>
                    </ListBox.ItemContainerStyle>
                </ListBox>
                
                <!-- Profile Buttons -->
                <Border Grid.Row="2" Background="{StaticResource SurfaceBrush}" Padding="12,10">
                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                        <Button Content="ï¼‹" Style="{StaticResource SmallPrimaryButton}" 
                                Click="NewProfile_Click" ToolTip="New profile" 
                                Width="32" Height="28" Padding="0" FontSize="14"/>
                        <Button Content="ðŸ“‹" Style="{StaticResource SmallIconButton}" 
                                Click="DuplicateProfile_Click" ToolTip="Duplicate profile" 
                                Width="32" Height="28" Padding="0" Margin="6,0,0,0"/>
                        <Button Content="âœŽ" Style="{StaticResource SmallIconButton}" 
                                Click="RenameProfile_Click" ToolTip="Rename profile" 
                                Width="32" Height="28" Padding="0" Margin="6,0,0,0"/>
                        <Button Content="ðŸ—‘" Style="{StaticResource SmallDangerButton}" 
                                Click="DeleteProfile_Click" ToolTip="Delete profile" 
                                Width="32" Height="28" Padding="0" Margin="6,0,0,0"/>
                    </StackPanel>
                </Border>
            </Grid>
        </Border>

        <!-- Header -->
        <Border Grid.Column="1" Grid.Row="0" Background="{StaticResource SurfaceBrush}" Padding="16,12">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <!-- Status & Stats -->
                <StackPanel Grid.Column="0" Orientation="Horizontal" VerticalAlignment="Center">
                    <Ellipse x:Name="StatusIndicator" Width="10" Height="10" Fill="{StaticResource ErrorBrush}" Margin="0,0,8,0"/>
                    <TextBlock x:Name="StatusText" Text="Paused" Foreground="{StaticResource TextBrush}" FontSize="14" FontWeight="SemiBold"/>
                    <TextBlock x:Name="StatsText" Text=" â€¢ 0/0 rules" Foreground="{StaticResource TextSecondaryBrush}" FontSize="12" Margin="8,0,0,0" VerticalAlignment="Center"/>
                </StackPanel>

                <!-- Compact Controls -->
                <StackPanel Grid.Column="2" Orientation="Horizontal">
                    <Button x:Name="ProfileToggleBtn" Content="ðŸ“" Width="32" Height="32" 
                            Style="{StaticResource IconButton}" 
                            Click="ToggleProfilePane_Click" 
                            ToolTip="Show/hide profiles"/>
                    
                    <ToggleButton x:Name="AutomationToggle" 
                                  Content="â–¶" 
                                  Width="32" Height="32" 
                                  ToolTip="Start/Stop all automation (Ctrl+Alt+T)"
                                  Click="AutomationToggle_Click"
                                  Style="{StaticResource TogglePlayButton}"/>
                    
                    <Button x:Name="ExpandButton" Content="âš™" Width="32" Height="32" Margin="6,0,0,0"
                            Style="{StaticResource IconButton}" 
                            Click="Settings_Click" 
                            ToolTip="Open settings"/>
                </StackPanel>
            </Grid>
        </Border>

        <!-- Rules Panel -->
        <Border Grid.Column="1" Grid.Row="1" Margin="8,6,8,4" Background="{StaticResource SurfaceBrush}" CornerRadius="6">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <!-- Rules Toolbar - Compact -->
                <Border Grid.Row="0" Background="{StaticResource CardBrush}" CornerRadius="6,6,0,0" Padding="8,4">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        
                        <!-- Search (expanded mode only) -->
                        <Border x:Name="SearchPanel" Grid.Column="0" Visibility="Collapsed" 
                                Background="{StaticResource SurfaceBrush}" CornerRadius="4" Padding="2" Margin="0,0,8,0">
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="ðŸ”" VerticalAlignment="Center" Margin="4,0,4,0" FontSize="11" Foreground="{StaticResource TextSecondaryBrush}"/>
                                <TextBox x:Name="SearchTextBox" Width="120" BorderThickness="0" Background="Transparent" 
                                         VerticalAlignment="Center" TextChanged="SearchTextBox_TextChanged" FontSize="11"
                                         ToolTip="Search rules (Esc to clear)"/>
                            </StackPanel>
                        </Border>
                        
                        <TextBlock Grid.Column="0" x:Name="RulesLabel" Text="Rules" FontSize="11" FontWeight="SemiBold" 
                                   Foreground="{StaticResource TextSecondaryBrush}" VerticalAlignment="Center"/>
                        
                        <!-- Compact buttons -->
                        <StackPanel Grid.Column="2" Orientation="Horizontal" HorizontalAlignment="Right">
                            <Button x:Name="ImportBtn" Content="ðŸ“¥" Style="{StaticResource SmallIconButton}" Click="ImportRules_Click" ToolTip="Import rules from JSON file" Visibility="Collapsed"/>
                            <Button x:Name="ExportBtn" Content="ðŸ“¤" Style="{StaticResource SmallIconButton}" Click="ExportRules_Click" ToolTip="Export rules to JSON file" Visibility="Collapsed" Margin="2,0,0,0"/>
                            <Button Content="ï¼‹" Style="{StaticResource SmallPrimaryButton}" Click="AddRule_Click" ToolTip="Add new automation rule (Ctrl+N)" Margin="4,0,0,0"/>
                            <Button x:Name="EditBtn" Content="âœŽ" Style="{StaticResource SmallIconButton}" Click="EditRule_Click" ToolTip="Edit selected rule (Ctrl+E)" Visibility="Collapsed" Margin="2,0,0,0"/>
                            <Button x:Name="DelBtn" Content="ðŸ—‘" Style="{StaticResource SmallDangerButton}" Click="DeleteRule_Click" ToolTip="Delete selected rule (Del)" Visibility="Collapsed" Margin="2,0,0,0"/>
                            <Button Content="â†»" Style="{StaticResource SmallIconButton}" Click="ReloadConfig_Click" ToolTip="Reload configuration (F5)" Margin="2,0,0,0"/>
                        </StackPanel>
                    </Grid>
                </Border>

                <!-- Compact Rules List -->
                <ListView x:Name="RulesListView" Grid.Row="1" BorderThickness="0" SelectionMode="Single" 
                          MouseDoubleClick="RulesListView_DoubleClick" SelectionChanged="RulesListView_SelectionChanged" FontSize="11">
                    <ListView.View>
                        <GridView x:Name="RulesGridView">
                            <!-- Status Indicator Column -->
                            <GridViewColumn x:Name="ColStatus" Header="" Width="22">
                                <GridViewColumn.CellTemplate>
                                    <DataTemplate>
                                        <Ellipse Width="8" Height="8" ToolTip="{Binding StatusTooltip}">
                                            <Ellipse.Fill>
                                                <SolidColorBrush Color="{Binding StatusColor}"/>
                                            </Ellipse.Fill>
                                        </Ellipse>
                                    </DataTemplate>
                                </GridViewColumn.CellTemplate>
                            </GridViewColumn>
                            <!-- Enable Checkbox Column -->
                            <GridViewColumn Header="" Width="28">
                                <GridViewColumn.CellTemplate>
                                    <DataTemplate>
                                        <CheckBox IsChecked="{Binding Enabled}" 
                                                  Checked="RuleEnabled_Changed" 
                                                  Unchecked="RuleEnabled_Changed"
                                                  ToolTip="Enable or disable this rule (saved in config)"/>
                                    </DataTemplate>
                                </GridViewColumn.CellTemplate>
                            </GridViewColumn>
                            <!-- Play/Pause Button Column -->
                            <GridViewColumn Header="" Width="26">
                                <GridViewColumn.CellTemplate>
                                    <DataTemplate>
                                        <Button Content="{Binding RunStateIcon}" 
                                                Click="RuleRunToggle_Click" 
                                                Tag="{Binding}"
                                                Style="{StaticResource SmallIconButton}" 
                                                Width="22" Height="20" FontSize="10" Padding="0"
                                                ToolTip="{Binding RunStateTooltip}"/>
                                    </DataTemplate>
                                </GridViewColumn.CellTemplate>
                            </GridViewColumn>
                            <GridViewColumn x:Name="ColName" Header="Name" Width="110" DisplayMemberBinding="{Binding Name}"/>
                            <GridViewColumn x:Name="ColApp" Header="App" Width="70" DisplayMemberBinding="{Binding TargetApp}"/>
                            <GridViewColumn x:Name="ColMatch" Header="Match" Width="90" DisplayMemberBinding="{Binding MatchText}"/>
                            <GridViewColumn x:Name="ColAction" Header="Action" Width="55" DisplayMemberBinding="{Binding Action}"/>
                            <GridViewColumn x:Name="ColCooldown" Header="CD" Width="30" DisplayMemberBinding="{Binding CooldownSeconds, StringFormat={}{0}s}"/>
                            <!-- Session Execution Count Column -->
                            <GridViewColumn x:Name="ColSessionExec" Header="" Width="35">
                                <GridViewColumn.CellTemplate>
                                    <DataTemplate>
                                        <TextBlock Text="{Binding SessionExecutionDisplay}" 
                                                   Foreground="{StaticResource AccentBrush}" 
                                                   FontSize="10"
                                                   ToolTip="Executions this session (resets on restart)"/>
                                    </DataTemplate>
                                </GridViewColumn.CellTemplate>
                            </GridViewColumn>
                            <GridViewColumn x:Name="ColTriggers" Header="#" Width="25" DisplayMemberBinding="{Binding TriggerCount}"/>
                            <GridViewColumn x:Name="ColLastTrigger" Header="Last" Width="55">
                                <GridViewColumn.CellTemplate>
                                    <DataTemplate>
                                        <TextBlock Text="{Binding LastTriggered, StringFormat={}{0:HH:mm:ss}, TargetNullValue=-}"/>
                                    </DataTemplate>
                                </GridViewColumn.CellTemplate>
                            </GridViewColumn>
                        </GridView>
                    </ListView.View>
                </ListView>
            </Grid>
        </Border>

        <!-- Splitter (expanded mode only) -->
        <GridSplitter x:Name="PanelSplitter" Grid.Column="1" Grid.Row="2" Height="5" HorizontalAlignment="Stretch" 
                      Background="{StaticResource SurfaceBrush}" Visibility="Collapsed"/>

        <!-- Log & Details Panel (expanded mode only) -->
        <Border x:Name="LogPanel" Grid.Column="1" Grid.Row="3" Margin="8,2,8,6" Background="{StaticResource SurfaceBrush}" CornerRadius="6" Visibility="Collapsed">
            <TabControl x:Name="BottomTabs" Background="Transparent" BorderThickness="0" FontSize="11">
                
                <!-- Log Tab -->
                <TabItem Header="ðŸ“‹ Log">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>

                        <Border Grid.Row="0" Background="{StaticResource CardBrush}" Padding="8,4">
                            <Grid>
                                <StackPanel Orientation="Horizontal">
                                    <ComboBox x:Name="LogLevelCombo" Width="70" FontSize="10" SelectionChanged="LogLevel_Changed">
                                        <ComboBoxItem Content="Debug"/>
                                        <ComboBoxItem Content="Info" IsSelected="True"/>
                                        <ComboBoxItem Content="Warning"/>
                                        <ComboBoxItem Content="Error"/>
                                    </ComboBox>
                                </StackPanel>
                                <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                                    <Button Content="Clear" Style="{StaticResource SmallButton}" Click="ClearLog_Click" Margin="0,0,4,0"/>
                                    <Button Content="Open" Style="{StaticResource SmallButton}" Click="OpenLogFile_Click"/>
                                </StackPanel>
                            </Grid>
                        </Border>

                        <ListBox x:Name="LogListBox" Grid.Row="1" BorderThickness="0" 
                                 Background="{StaticResource SurfaceBrush}" 
                                 Foreground="{StaticResource TextBrush}"
                                 FontFamily="Consolas" FontSize="10"
                                 ScrollViewer.HorizontalScrollBarVisibility="Auto"/>
                    </Grid>
                </TabItem>
                
                <!-- Timeline Tab -->
                <TabItem Header="ðŸ“Š Timeline">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>

                        <Border Grid.Row="0" Background="{StaticResource CardBrush}" Padding="8,4">
                            <Grid>
                                <ComboBox x:Name="TimelineFilterCombo" Width="100" FontSize="10" SelectionChanged="TimelineFilter_Changed">
                                    <ComboBoxItem Content="All" IsSelected="True" Tag=""/>
                                    <ComboBoxItem Content="Matches" Tag="RuleMatch"/>
                                    <ComboBoxItem Content="Actions" Tag="Action"/>
                                </ComboBox>
                                <Button Content="Clear" Style="{StaticResource SmallButton}" HorizontalAlignment="Right" Click="ClearTimeline_Click"/>
                            </Grid>
                        </Border>

                        <ListView x:Name="TimelineListView" Grid.Row="1" BorderThickness="0"
                                  Background="{StaticResource SurfaceBrush}" FontSize="10">
                            <ListView.View>
                                <GridView>
                                    <GridViewColumn Header="" Width="24">
                                        <GridViewColumn.CellTemplate>
                                            <DataTemplate>
                                                <TextBlock Text="{Binding Icon}" FontSize="11"/>
                                            </DataTemplate>
                                        </GridViewColumn.CellTemplate>
                                    </GridViewColumn>
                                    <GridViewColumn Header="Time" Width="55">
                                        <GridViewColumn.CellTemplate>
                                            <DataTemplate>
                                                <TextBlock Text="{Binding Timestamp, StringFormat={}{0:HH:mm:ss}}" Foreground="{StaticResource TextSecondaryBrush}"/>
                                            </DataTemplate>
                                        </GridViewColumn.CellTemplate>
                                    </GridViewColumn>
                                    <GridViewColumn Header="Rule" Width="80" DisplayMemberBinding="{Binding RuleName}"/>
                                    <GridViewColumn Header="Event" Width="200" DisplayMemberBinding="{Binding Message}"/>
                                </GridView>
                            </ListView.View>
                        </ListView>
                    </Grid>
                </TabItem>
                
                <!-- Plugins Tab -->
                <TabItem Header="ðŸ”Œ Plugins">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>

                        <Border Grid.Row="0" Background="{StaticResource CardBrush}" Padding="8,4">
                            <Grid>
                                <TextBlock Text="Plugins" Foreground="{StaticResource TextSecondaryBrush}" FontSize="10" VerticalAlignment="Center"/>
                                <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                                    <Button Content="â†»" Style="{StaticResource SmallIconButton}" Click="RefreshPlugins_Click" Margin="0,0,4,0"/>
                                    <Button Content="ðŸ“‚" Style="{StaticResource SmallIconButton}" Click="OpenPluginsFolder_Click"/>
                                </StackPanel>
                            </Grid>
                        </Border>

                        <ListView x:Name="PluginsListView" Grid.Row="1" BorderThickness="0"
                                  Background="{StaticResource SurfaceBrush}" FontSize="10">
                            <ListView.View>
                                <GridView>
                                    <GridViewColumn Header="" Width="28">
                                        <GridViewColumn.CellTemplate>
                                            <DataTemplate>
                                                <CheckBox IsChecked="{Binding Enabled}" Checked="PluginEnabled_Changed" Unchecked="PluginEnabled_Changed"/>
                                            </DataTemplate>
                                        </GridViewColumn.CellTemplate>
                                    </GridViewColumn>
                                    <GridViewColumn Header="Name" Width="100" DisplayMemberBinding="{Binding Name}"/>
                                    <GridViewColumn Header="Type" Width="50" DisplayMemberBinding="{Binding Type}"/>
                                    <GridViewColumn Header="Description" Width="180" DisplayMemberBinding="{Binding Description}"/>
                                </GridView>
                            </ListView.View>
                        </ListView>
                    </Grid>
                </TabItem>
            </TabControl>
        </Border>

        <!-- Footer -->
        <Border Grid.Column="1" Grid.Row="4" Background="{StaticResource SurfaceBrush}" Padding="16,10">
            <Grid>
                <StackPanel Orientation="Horizontal">
                    <TextBlock x:Name="ProfileIndicator" Text="Default" 
                               Foreground="{StaticResource AccentBrush}" 
                               FontSize="11" FontWeight="SemiBold"
                               VerticalAlignment="Center"
                               ToolTip="Active profile"/>
                    <TextBlock Text="  â€¢  " Foreground="{StaticResource TextSecondaryBrush}" FontSize="11" VerticalAlignment="Center"/>
                    <TextBlock x:Name="HotkeyHint" Text="Ctrl+Alt+T" 
                               Foreground="{StaticResource TextSecondaryBrush}" 
                               FontSize="11" 
                               VerticalAlignment="Center"/>
                    <TextBlock x:Name="IntervalText" Text="  â€¢  10s" 
                               Foreground="{StaticResource TextSecondaryBrush}" 
                               FontSize="11" 
                               VerticalAlignment="Center"/>
                </StackPanel>
                <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                    <ComboBox x:Name="IntervalCombo" Width="60" FontSize="10" Visibility="Collapsed"
                              ToolTip="Polling interval" SelectionChanged="IntervalCombo_Changed">
                        <ComboBoxItem Content="1s" Tag="1000"/>
                        <ComboBoxItem Content="3s" Tag="3000" IsSelected="True"/>
                        <ComboBoxItem Content="5s" Tag="5000"/>
                        <ComboBoxItem Content="10s" Tag="10000"/>
                    </ComboBox>
                    <TextBlock Text="v1.0.0" 
                               Foreground="{StaticResource TextSecondaryBrush}" 
                               FontSize="10" 
                               VerticalAlignment="Center"
                               ToolTip="Idol Click v1.0.0"/>
                </StackPanel>
            </Grid>
        </Border>
    </Grid>
</Window>
